name: Build and Release AppImage for Linux

on:
  push:
    branches:
     - autobuild
    tags:
      - '*' # run on every tag pushed to master

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Set up Qt environment
    - name: Set up Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.*' # Replace with your Qt version
        host: 'linux'
        target: 'desktop'
        arch: 'linux_gcc_64'

    # Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake \
          qtbase5-dev qttools5-dev-tools \
          libx11-dev libxext-dev libxrandr-dev \
          libgl1-mesa-dev zlib1g-dev \
          patchelf fuse

    # Build the application
    - name: Build application
      run: |
        mkdir build
        cd build
        qmake .. -spec linux-g++ CONFIG+=release
        make -j$(nproc)

    # Package as AppImage
    - name: Package as AppImage
      run: |
        wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
        chmod +x linuxdeployqt-continuous-x86_64.AppImage
        mkdir -p AppDir/usr/bin
        cp build/cob-taylor-games AppDir/usr/bin/
        cp appimage/cob-taylor-games.desktop AppDir/usr/share/applications/
        ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/bin/cob-taylor-games -appimage -unsupported-allow-new-glibc

    # Upload AppImage to GitHub release
    - name: Upload AppImage to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: cob-taylor-games-x86_64.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
